<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orden de Compra de Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="container mt-5">
        <h2>Orden de Compra de Productos</h2>
        <form id="ordenCompraForm">
            <div class="mb-3">
                <label for="id_pasajero" class="form-label">ID Pasajero</label>
                <input type="text" class="form-control" id="id_pasajero" required>
            </div>
            <div id="productosContainer"></div>
            <button type="button" class="btn btn-primary" id="agregarProducto">Agregar Producto</button>
            <button type="submit" class="btn btn-success mt-3">Enviar Orden</button>
        </form>
    </div>

    <script>
        $(document).ready(function () {
            let productoCount = 0;

            function cargarCategorias(selectElement) {
                $.get('{% url "api_product_categories" %}', function (categorias) {
                    console.log('{% url "api_product_categories" %}')
                    selectElement.empty();
                    selectElement.append('<option value="">Seleccione una categoría</option>');
                    categorias.forEach(function (categoria) {
                        selectElement.append(`<option value="${categoria.id}">${categoria.name}</option>`);
                    });
                });
            }

            function cargarProductos(categoriaId, selectElement) {
                $.get(`../api/products_per_category/?category_id=${categoriaId}`, function (productos) {
                    selectElement.empty();
                    selectElement.append('<option value="">Seleccione un producto</option>');
                    productos.forEach(function (producto) {
                        selectElement.append(`<option value="${producto.id}">${producto.name}</option>`);
                    });
                });
            }

            function agregarProductoForm() {
                productoCount++;
                const productoHtml = `
                    <div class="producto-form mb-3" id="producto-${productoCount}">
                        <h4>Producto ${productoCount}</h4>
                        <div class="mb-2">
                            <label for="categoria-${productoCount}" class="form-label">Categoría</label>
                            <select class="form-select categoria-select" id="categoria-${productoCount}" required>
                                <option value="">Cargando categorías...</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="producto-${productoCount}" class="form-label">Producto</label>
                            <select class="form-select producto-select" id="producto-${productoCount}" required>
                                <option value="">Seleccione una categoría primero</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="cantidad-${productoCount}" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="cantidad-${productoCount}" min="1" required>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm eliminar-producto">Eliminar Producto</button>
                    </div>
                `;
                $('#productosContainer').append(productoHtml);
                cargarCategorias($(`#categoria-${productoCount}`));
            }

            $('#agregarProducto').click(agregarProductoForm);

            $(document).on('change', '.categoria-select', function () {
                const categoriaId = $(this).val();
                const productoSelect = $(this).closest('.producto-form').find('.producto-select');
                if (categoriaId) {
                    cargarProductos(categoriaId, productoSelect);
                } else {
                    productoSelect.html('<option value="">Seleccione una categoría primero</option>');
                }
            });

            $(document).on('click', '.eliminar-producto', function () {
                $(this).closest('.producto-form').remove();
            });

            $('#ordenCompraForm').submit(function (e) {
                e.preventDefault();
                const formData = {
                    id_pasajero: $('#id_pasajero').val(),
                    productos: []
                };

                $('.producto-form').each(function () {
                    const categoriaId = $(this).find('.categoria-select').val();
                    const productoId = $(this).find('.producto-select').val();
                    const cantidad = $(this).find('input[type="number"]').val();

                    if (categoriaId && productoId && cantidad) {
                        formData.productos.push({
                            categoria_id: categoriaId,
                            producto_id: productoId,
                            cantidad: cantidad
                        });
                    }
                });

                console.log(formData);

                // $.ajax({
                //     url: '/api/orden-compra',
                //     method: 'POST',
                //     contentType: 'application/json',
                //     data: JSON.stringify(formData),
                //     success: function (response) {
                //         alert('Orden de compra enviada con éxito');
                //         $('#ordenCompraForm')[0].reset();
                //         $('#productosContainer').empty();
                //     },
                //     error: function () {
                //         alert('Error al enviar la orden de compra');
                //     }
                // });
            });

            // Agregar el primer producto al cargar la página
            agregarProductoForm();
        });
    </script>
</body>

</html>