<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"
        integrity="sha384-LtrjvnR4Twt/qOuYxE721u19sVFLVSA4hf/rRt6PrZTmiPltdZcI7q7PXQBYTKyf"
        crossorigin="anonymous"></script>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Reserva de Boletos de Tren</h1>
        <form id="reservaForm">
            {% csrf_token %}
            {% if user.is_authenticated %}
            <input type="hidden" id="id-user" value="{{ user.id }}">
            {% endif %}
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div id="pasajeros">
                <!-- Aquí se agregarán dinámicamente los formularios de pasajeros -->
            </div>
            <button type="button" class="btn btn-primary mb-3" id="agregarPasajero">Agregar Pasajero</button>
            <button type="submit" class="btn btn-success">Enviar Reserva</button>
        </form>
    </div>
    <!-- Modal para crear un nuevo pasajero -->
    <div id="passenger-modal" class="modal fade font-black" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Información del Pasajero</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="new-passenger-form-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            let contadorPasajeros = 0;

            function cargarTiposRecorrido(select) {
                $.get('{% url "api_types_journey" %}', function (data) {
                    select.empty();
                    data.forEach(function (tipo) {
                        select.append($('<option></option>').val(tipo[0]).text(tipo[1]));
                    });
                });
            }

            function cargarHorarios(fecha, tipoRecorrido, select) {
                $.get('{% url "api_journey_per_date" %}', {
                    fecha: fecha,
                    tipo_recorrido: tipoRecorrido
                }, function (data) {
                    select.empty();
                    if (data.length > 0) {
                        select.append($('<option></option>').val("").text("Seleccione un Horario"));
                        data.forEach(function (horario) {
                            select.append($('<option></option>').val(horario.id).text(horario.departure_time + ' - ' + horario.arrival_time));
                        });
                    } else {
                        select.append($('<option></option>').val("").text("Sin recorridos disponibles"));
                    }
                });
            }
            function cargarCategorias(tipoRecorrido, select) {
                $.get('{% url "api_price_journey" %}', {
                    tipo_recorrido: tipoRecorrido
                }, function (data) {
                    console.log(data);
                    select.empty();
                    if (data.length > 0) {
                        select.append($('<option></option>').val("").text("Seleccione una Categoria"));
                        data.forEach(function (categoria) {
                            select.append($('<option></option>').val(categoria.id).text(categoria.category + ' - $' + categoria.price));
                        });
                    } else {
                        select.append($('<option></option>').val("").text("Sin recorridos disponibles"));
                    }
                    select.prop('disabled', false);
                });
            }

            function cargarAsientos(categoria, horario, select) {
                $.get('{% url "api_available_seats_per_schedule" %}', {
                    categoria: categoria,
                    horario: horario
                }, function (data) {
                    select.empty();
                    select.append($('<option></option>').val("").text("Seleccione un Asientos"));
                    data.forEach(function (asiento) {
                        select.append($('<option></option>').val(asiento.id).text(asiento.numero));
                    });
                    select.prop('disabled', false);
                });
            }

            function agregarPasajero() {
                contadorPasajeros++;
                let pasajeroHtml = `
                    <div class="pasajero-form mb-4" data-pasajero="${contadorPasajeros}">
                        <h3>Pasajero ${contadorPasajeros}</h3>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Recorrido</label>
                            <select class="form-select tipo-recorrido" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-control fecha" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Horario</label>
                            <select class="form-select horario" required disabled></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select class="form-select categoria" required disabled></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Asiento</label>
                            <select class="form-select asiento" required disabled></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">DNI o Pasaporte</label>
                            <input type="text" class="form-control dni_o_pasaporte" required>
                        </div>
                        <button type="button" class="btn btn-danger eliminar-pasajero">Eliminar Pasajero</button>
                    </div>
                `;
                $('#pasajeros').append(pasajeroHtml);

                let nuevoSelect = $(`[data-pasajero="${contadorPasajeros}"] .tipo-recorrido`);
                cargarTiposRecorrido(nuevoSelect);
            }

            $('#agregarPasajero').click(agregarPasajero);

            $(document).on('change', '.fecha, .tipo-recorrido', function () {
                let pasajeroForm = $(this).closest('.pasajero-form');
                let fecha = pasajeroForm.find('.fecha').val();
                let tipoRecorrido = pasajeroForm.find('.tipo-recorrido').val();
                let horarioSelect = pasajeroForm.find('.horario');
                let asientoSelect = pasajeroForm.find('.asiento');
                if (fecha && tipoRecorrido) {
                    horarioSelect.prop('disabled', false);
                    cargarHorarios(fecha, tipoRecorrido, horarioSelect);
                } else {
                    horarioSelect.prop('disabled', true);
                    horarioSelect.empty();
                }

                // Resetear y deshabilitar la selección de asientos
                asientoSelect.prop('disabled', true);
                asientoSelect.empty();
            });

            $(document).on('change', '.horario', function () {
                let pasajeroForm = $(this).closest('.pasajero-form');
                let fecha = pasajeroForm.find('.fecha').val();
                let tipoRecorrido = pasajeroForm.find('.tipo-recorrido').val();
                let horario = $(this).val();
                let categoriaSelect = pasajeroForm.find('.categoria');
                let asientoSelect = pasajeroForm.find('.asiento');
                console.log(fecha);
                if (fecha && horario) {
                    cargarCategorias(tipoRecorrido, categoriaSelect);
                    // cargarAsientos(fecha, horario, asientoSelect);
                } else {
                    categoriaSelect.prop('disabled', true);
                    categoriaSelect.empty();
                    asientoSelect.prop('disabled', true);
                    asientoSelect.empty();
                }
            });

            $(document).on('change', '.categoria', function () {
                let pasajeroForm = $(this).closest('.pasajero-form');
                let categoria = $(this).val();
                let horario = pasajeroForm.find('.horario').val();
                let asientoSelect = pasajeroForm.find('.asiento');
                console.log(horario);
                if (categoria && horario) {
                    cargarAsientos(categoria, horario, asientoSelect);
                } else {
                    categoriaSelect.prop('disabled', true);
                    categoriaSelect.empty();
                    asientoSelect.prop('disabled', true);
                    asientoSelect.empty();
                }
            });

            $(document).on('click', '.eliminar-pasajero', function () {
                $(this).closest('.pasajero-form').remove();
            });


            function openCreatePassengerModal(dni_or_passport) {
                $.get('{% url "create_passenger" %}', {
                    dni_or_passport: dni_or_passport
                }, function (data) {
                    $('#new-passenger-form-container').html(data);
                    $('#passenger-modal').modal('show');
                }).fail(function () {
                    alert("Fallo al cargar el modal. Por favor, intenta de nuevo.");
                });
            }

            $(document).on('blur', '.dni_o_pasaporte', function () {
                var dni_or_passport = $(this).val();
                var inputField = $(this); // Referencia al campo de entrada
                if (dni_or_passport) {
                    openCreatePassengerModal(dni_or_passport);
                }
            });

            $('#reservaForm').submit(function (e) {
                e.preventDefault();
                id_user = $('#id-user').val();
                let reserva;
                if (id_user === undefined) {
                    reserva = {
                        email: $('#email').val(),
                        pasajeros: []
                    };
                } else {
                    reserva = {
                        email: $('#email').val(),
                        id_user: id_user,
                        pasajeros: []
                    };
                }
                console.log(reserva)
                $('.pasajero-form').each(function () {
                    let pasajero = {
                        tipoRecorrido: $(this).find('.tipo-recorrido').val(),
                        fecha: $(this).find('.fecha').val(),
                        horario: $(this).find('.horario').val(),
                        asiento: $(this).find('.asiento').val(),
                        dni_o_pasaporte: $(this).find('.dni_o_pasaporte').val()
                    };
                    reserva.pasajeros.push(pasajero);
                });

                console.log(JSON.stringify(reserva))

                $.ajax({
                    url: '{% url "api_reserve_tickets" %}',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(reserva),
                    success: function (response) {
                        if (response.success) {
                            window.location.href = response.init_point;
                        } else {
                            console.error('Error en la respuesta:', response);
                            alert('Hubo un error al procesar su pago');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error en la petición:', error);
                        alert('Hubo un error al procesar su solicitud');
                    }
                });
            });

            // Agregar el primer pasajero al cargar la página
            agregarPasajero();
        });
    </script>
</body>

</html>