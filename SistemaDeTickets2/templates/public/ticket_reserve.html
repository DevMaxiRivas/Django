<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Boletos de Tren</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Reserva de Boletos de Tren</h1>
        <form id="reservaForm">
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div id="pasajeros">
                <!-- Aquí se agregarán dinámicamente los formularios de pasajeros -->
            </div>
            <button type="button" class="btn btn-primary mb-3" id="agregarPasajero">Agregar Pasajero</button>
            <button type="submit" class="btn btn-success">Enviar Reserva</button>
        </form>
    </div>

    <script>
        $(document).ready(function () {
            let contadorPasajeros = 0;

            function cargarTiposRecorrido(select) {
                $.get('{% url "api_types_journey" %}', function (data) {
                    select.empty();
                    data.forEach(function (tipo) {
                        select.append($('<option></option>').val(tipo[0]).text(tipo[1]));
                    });
                });
            }

            function cargarHorarios(fecha, select) {
                $.get('{% url "api_journey_per_date" %}', { fecha: fecha }, function (data) {
                    select.empty();
                    data.forEach(function (horario) {
                        select.append($('<option></option>').val(horario.id).text(horario.departure_time + ' - ' + horario.arrival_time));
                    });
                });
            }

            function agregarPasajero() {
                contadorPasajeros++;
                let pasajeroHtml = `
                    <div class="pasajero-form mb-4" data-pasajero="${contadorPasajeros}">
                        <h3>Pasajero ${contadorPasajeros}</h3>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Recorrido</label>
                            <select class="form-select tipo-recorrido" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-control fecha" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Horario</label>
                            <select class="form-select horario" required disabled></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">DNI</label>
                            <input type="text" class="form-control dni" required>
                        </div>
                        <button type="button" class="btn btn-danger eliminar-pasajero">Eliminar Pasajero</button>
                    </div>
                `;
                $('#pasajeros').append(pasajeroHtml);

                let nuevoSelect = $(`[data-pasajero="${contadorPasajeros}"] .tipo-recorrido`);
                cargarTiposRecorrido(nuevoSelect);
            }

            $('#agregarPasajero').click(agregarPasajero);

            $(document).on('change', '.fecha', function () {
                let fecha = $(this).val();
                let horarioSelect = $(this).closest('.pasajero-form').find('.horario');
                horarioSelect.prop('disabled', false);
                cargarHorarios(fecha, horarioSelect);
            });

            $(document).on('click', '.eliminar-pasajero', function () {
                $(this).closest('.pasajero-form').remove();
            });

            $('#reservaForm').submit(function (e) {
                e.preventDefault();
                let reserva = {
                    email: $('#email').val(),
                    pasajeros: []
                };

                $('.pasajero-form').each(function () {
                    let pasajero = {
                        tipoRecorrido: $(this).find('.tipo-recorrido').val(),
                        fecha: $(this).find('.fecha').val(),
                        horario: $(this).find('.horario').val(),
                        dni: $(this).find('.dni').val()
                    };
                    reserva.pasajeros.push(pasajero);
                });

                $.ajax({
                    url: '/api/reservar',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(reserva),
                    success: function (response) {
                        alert('Reserva realizada con éxito');
                        $('#reservaForm')[0].reset();
                        $('#pasajeros').empty();
                    },
                    error: function () {
                        alert('Error al realizar la reserva');
                    }
                });
            });

            // Agregar el primer pasajero al cargar la página
            agregarPasajero();
        });
    </script>
</body>

</html>