<script>
    $(document).ready(function() {
        $('#ticket-form').submit(function (e) {
            e.preventDefault();

            // Validacion de campos de formulario
            var formValid = true;
            $('#ticket-forms .ticket-form').each(function () {
                $(this).find('.form-control').each(function () {
                    if ($.trim($(this).val()) === '') {
                        $(this).addClass('is-invalid');
                        formValid = false;
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });
            });

            if (!formValid) {
                alert("Please fill out all fields in each ticket form.");
                return;
            }

            // Si los formularios estan completos
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: $(this).serialize(),
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        window.location.href = response.redirect_url;
                    } else {
                        for (var key in response.errors) {
                            var field = $('#' + key);
                            field.addClass('is-invalid');
                            field.siblings('.invalid-feedback').text(response.errors[key]);
                        }
                    }
                },
                error: function (xhr) {
                    var response = xhr.responseJSON;
                    if (response && response.error && response.missing_passengers) {
                        openCreatePassengerModal(response.missing_passengers);
                    } else {
                        alert('An unexpected error occurred. Please try again.');
                    }
                }
            });
        });

    function openCreatePassengerModal(dni_or_passport) {
        $.get('{% url "create_passenger" %}', {
            dni_or_passport: dni_or_passport
        }, function (data) {
            $('#new-passenger-form-container').html(data);
            $('#passenger-modal').modal('show');
        }).fail(function () {
            alert('Failed to load modal content. Please try again.');
        });
    }

    $('#add-ticket').click(function() {
      var form_idx = $('#id_tickets-TOTAL_FORMS').val();
    var empty_form_html = $('#empty-form').html().replace(/__prefix__/g, form_idx);
    $('#ticket-forms').append(empty_form_html);
    $('#id_tickets-TOTAL_FORMS').val(parseInt(form_idx) + 1);
    });
  });
</script>